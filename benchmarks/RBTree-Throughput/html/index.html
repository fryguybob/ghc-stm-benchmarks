<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Graph</title>
    <script type="text/javascript" src="graph.js"></script>
    <link rel="stylesheet" type="text/css" href="style.css" />
    <link rel="icon" href="data:image/png;base64,iVBORw0KGgo=">
</head>
<body>
    <div id="controls">
        <select id="selData" onchange="loadUrl()">
        </select>
        <button onclick="loadUrl()">Fetch</button>
        <button onclick="compare()">Compare</button>
        <button onclick="compareRBTree()">Compare RB</button>
    </div>
    <script type="application/text" id="data">
        Threads  mut-CPS-hybrid        mut-CPS               mut-ref-hybrid        mut-ref               mut-hybrid           mut                   TVar-hybrid         TVar
        1        1365487.8898819825    933673.7939299952     1408891.9292227875    891314.732813808      1503471.0338263402   968532.0827925175     939784.9680163766   752102.6413318703         
        2        2114666.053072982     1834173.2768703145    2056540.8240589853    1907580.7976040118    2195622.4815410236   1916725.7937148365    1594702.928754882   1544102.730290251         
        3        2870708.3890741565    2659001.085251456     2944584.6553258765    2607437.3668075735    3052753.812183281    2733109.5394859645    2142505.4407084733  2127554.2427712097        
        4        3905939.6599327894    3493597.3677837956    3829021.7218056396    3432814.375822674     3928606.231190292    3705915.7118210546    2756359.544782343   2814413.4408275145        
        5        4682732.280857339     4230685.832025693     4597128.182912028     4247452.788315378     4602438.13933001     4373537.20977958      3225469.124628077   3263367.0925153634        
        6        5456443.858776132     4930454.912839907     5428306.86554817      4705732.07151493      5543186.369706753    5206103.141148317     3765211.9130384163  3879338.402348461         
        7        6089605.458995795     5597908.841042728     5735251.073683526     5333322.034956945     5953723.793781881    5700304.28077681      4084735.470064966   4272714.92646             
        8        6779330.170687438     6140428.203634872     6339622.219255739     5896444.086065122     6900834.212862676    6286779.206762122     4551027.385173472   4875200.337613094         
        9        7437458.979960426     6781635.466634984     6546467.846679708     6508162.583760551     7353699.987926231    6735192.252991193     4663465.109326103   4918656.73059619          
        10       8422182.25544285      7383254.24853523      7537996.493288663     7305865.344843153     8215145.222366383    7798481.61995149      5265474.081023165   5554803.8127466235        
        11       9055141.25713307      8238991.1491894545    8282638.036121451     7893827.11836309      9060625.950449623    8281133.080083413     5381101.525588518   5909913.623285863         
        12       1.0007639183829507e7  8968451.160526514     8826170.428587183     8599039.34834881      9558928.842269864    9183315.507315094     6132797.936614985   6255916.412237403         
        13       1.0516722731026692e7  9660751.794003021     9378138.507597396     9361273.256000886     1.0350671193039324e7 1.009862770731737e7   6251526.408608786   6653273.238579751         
        14       1.1105109568781981e7  1.0439623962130371e7  1.0258771953775669e7  1.0022277460937854e7  1.1405682969111465e7 1.0877859508936634e7  6171392.302953812   6912712.348681192         
        15       1.184109531458997e7   1.0965216476894403e7  1.0383142717837371e7  1.032699551164116e7   1.230461372596916e7  1.129259603551014e7   6780467.061369192   7512567.714521719         
        16       1.3001726221796589e7  1.1802100358403405e7  1.1208471297494646e7  1.1418462746266704e7  1.2894291340377863e7 1.2023043850215351e7  6504087.865235881   7605883.006313897         
        17       1.3508767449360937e7  1.2466704234075088e7  1.1580116458661992e7  1.1693127722813502e7  1.3543909344772287e7 1.2840691266382338e7  7661277.760603579   8249696.2927619945        
        18       1.424346524850648e7   1.3308844092496984e7  1.2255510287509337e7  1.2611906516414294e7  1.4521057862858929e7 1.3609149754115347e7  7865269.144545225   8390273.08429554          
        19       1.6122092547014132e7  1.3122974076298246e7  1.2075461243867513e7  1.225032844220608e7   1.5912638871678863e7 1.3514928025371471e7  6093398.107318367   7728665.891810646         
        20       1.5652206236503456e7  1.3702739668107351e7  1.2441925913090134e7  1.2455322823498568e7  1.6568114359100277e7 1.3714995674126577e7  6228588.405568618   7766883.167279308         
        21       1.6473284133428114e7  1.414674394602494e7   1.264806611943208e7   1.2572586680601003e7  1.700261482298823e7  1.4417766744459681e7  6314112.105016709   7575599.974511187         
        22       1.6956302832987454e7  1.4363485550520435e7  1.3126008528791491e7  1.2876416833659727e7  1.747085727419342e7  1.4957787445779406e7  5827199.61129809    7374529.692271599         
        23       1.791275917445027e7   1.4942025651164774e7  1.327983027708784e7   1.3079026310448185e7  1.814239035050295e7  1.539279039533583e7   5529227.578611899   7430473.91423081          
        24       1.822362542743254e7   1.5495986770361075e7  1.3658711266682014e7  1.3301978634276448e7  1.840410343304053e7  1.592073351453526e7   5563637.877499385   7773003.807674715         
        25       1.888699694486752e7   1.5763290039648518e7  1.4086052889493018e7  1.3939868528106915e7  1.890129787936199e7  1.6310696464219453e7  5081480.098393317   7546848.873727621         
        26       1.918153867501879e7   1.6297404688693179e7  1.4467426039611058e7  1.4307641468841977e7  1.9582807402616702e7 1.6689456910283767e7  5815882.987167251   7857399.135376013         
        27       1.9782972367018573e7  1.679134184549925e7   1.4945933933267744e7  1.4918158728686327e7  2.0017358187850147e7 1.6972297908549715e7  5612073.458667057   7185348.944272386         
        28       2.0303598797351707e7  1.7352972564387426e7  1.529923607304608e7   1.4944918543231938e7  2.037744120165455e7  1.754840946976437e7   5640508.465171103   8192281.6850345135        
        29       2.0577078568052705e7  1.7913449812647678e7  1.5714984046892306e7  1.5483755026056558e7  2.1238194913794983e7 1.8336621503356397e7  5824987.140044818   7703493.041146189         
        30       2.1764880794396006e7  1.826064983201503e7   1.6301502976506209e7  1.5918360420969198e7  2.098971603228584e7  1.890146374223282e7   6095837.130466112   7930560.331494019         
        31       2.191419578240896e7   1.8559647427207433e7  1.6093426961971374e7  1.5979943947462816e7  2.165876354960652e7  1.9259677528867625e7  4464561.360901608   7925850.408539626         
        32       2.2205891453572243e7  1.9127141411140207e7  1.6684187453068648e7  1.6556007474989831e7  2.2764642518980667e7 1.943177087728281e7   4934214.895340322   8278740.927524516         
        33       2.2916690015004057e7  1.9580108918704618e7  1.688328895910389e7   1.6896781355011668e7  2.3963768000267923e7 2.00434433830399e7    4197010.513701293   7894209.65228233          
        34       2.3118407244614e7     1.984578224667474e7   1.749180797055258e7   1.7305318026382513e7  2.3677365677791934e7 2.071554342671497e7   5793662.930031935   7843307.953925785         
        35       2.3667129004054572e7  2.026034705753365e7   1.744482341236266e7   1.749610236320639e7   2.4109330187798586e7 2.1303270152449954e7  4802607.288987773   7851272.890100334         
        36       2.428158437599417e7   2.070673904847038e7   1.791421804849519e7   1.7832358714635424e7  2.5470789683033604e7 2.159907298462356e7   4998493.656856466   8489108.837658983         
        37       2.4525828076082814e7  2.0683840458687764e7  1.861719405204329e7   1.752252004276143e7   2.5199166305148073e7 2.164843992040383e7   4832275.599568281   8710651.559178574         
        38       2.4794809404511727e7  2.10163294703569e7    1.8144658217561778e7  1.7834105231059164e7  2.597758470784465e7  2.236652747351245e7   5065875.611989962   7881999.973722647         
        39       2.5192119246983267e7  2.1134774807899266e7  1.8145869842525445e7  1.7811515558300212e7  2.584696645946881e7  2.163135095999044e7   4739773.3666245     8308883.9074981045        
        40       2.5378390496081203e7  2.1342362350405384e7  1.8557998368049756e7  1.852479020500817e7   2.6601963955225036e7 2.2147869452047363e7  4190640.0424351697  8505766.993214611         
        41       2.5055332920179557e7  2.1128666551874757e7  1.8807868133445516e7  1.8214873661314823e7  2.5831316399563342e7 2.2100605006380945e7  4106801.4724940294  8542044.373623863         
        42       2.565059217527267e7   2.172723077449582e7   1.878468461660755e7   1.858465800030555e7   2.6274398769429374e7 2.2657264835277833e7  5189222.751473403   7766661.599952848         
        43       2.5794686688923746e7  2.1460366810448788e7  1.912298145654174e7   1.84663670720136e7    2.6962404840020914e7 2.2408378446650166e7  4630214.9236966325  7735771.864321963         
        44       2.560631124776414e7   2.207587932452471e7   1.9180374019779198e7  1.8540800802912172e7  2.714184999356802e7  2.291185440490752e7   3991603.303788802   7001641.486603992         
        45       2.557851734740658e7   2.1863635239844777e7  1.950216918609496e7   1.8375978615204524e7  2.6910822685203537e7 2.3176196113952298e7  4661062.203538001   7373890.311522531         
        46       2.6729729729486454e7  2.1972199216764417e7  1.935728382709474e7   1.896123022322264e7   2.728861071616667e7  2.304975264703868e7   5224749.76136662    7917266.679681474         
        47       2.6186744879907824e7  2.2180346904012695e7  1.9411281693253532e7  1.8206737999635838e7  2.7727469149183404e7 2.303573353958777e7   4614006.984030641   8508333.876052635         
        48       2.703938624078063e7   2.2434758772234302e7  1.9527952957337867e7  1.905046042115406e7   2.7401893686784662e7 2.3528446402228046e7  4352726.0319309365  8321704.969279068         
        49       2.7062720196899477e7  2.220453264804389e7   1.9859923590201844e7  1.8796030813082404e7  2.8441383775205735e7 2.365886331634203e7   4192150.3207172793  7612627.769471668         
        50       2.6620896332618874e7  2.2727480595506817e7  1.9766976821767062e7  1.8940755767595258e7  2.7419066932263426e7 2.353406505040033e7   4311728.245387784   6990838.292337226         
        51       2.6512668860745285e7  2.28742890086804e7    1.9901175517540086e7  1.933581360780937e7   2.8793164572627984e7 2.377912444024037e7   4529093.884673762   8160291.928424919         
        52       2.7405560555078782e7  2.3067959660192776e7  1.9862837459737103e7  1.8989727083441645e7  2.818172592489685e7  2.3746395719065174e7  3927092.9902389     7113536.482492226         
        53       2.675977296964056e7   2.2896245446945444e7  2.041161812550948e7   1.8802248928656336e7  2.7759806311861504e7 2.4148828454894047e7  4300712.889129249   7576954.979662535         
        54       2.7029008365782052e7  2.3172052763501465e7  2.032116495421566e7   1.928565112451975e7   2.8118338485471997e7 2.437252560421829e7   4523353.773480133   6966034.234886075         
        55       2.799202949809631e7   2.299657439706868e7   2.0467045462672953e7  1.934923296065501e7   2.8221098156339597e7 2.437065022570353e7   4470415.4039779175  7086192.202475791         
        56       2.7012367825442325e7  2.3391611653733704e7  2.061756313526137e7   1.8124249763255797e7  2.812989849556992e7  2.449479510592584e7   5056771.789211228   7947261.340367691         
        57       2.7314036485200785e7  2.349784508248749e7   2.0874080063356522e7  1.942446994390313e7   2.8546037582027454e7 2.441348745408808e7   3250252.5213881806  7221106.098462968         
        58       2.7912054511224907e7  2.368582799453129e7   2.1579922342383657e7  1.960023931989772e7   2.7822247474636216e7 2.49387883276859e7    4198813.875127338   7521879.326643063         
        59       2.8081923780195277e7  2.382427327875223e7   2.1433655311028972e7  1.9401968384060815e7  2.9431027394599486e7 2.5135646200088028e7  3921095.383678946   7352160.414800731         
        60       2.8070747204347245e7  2.4003137479332585e7  2.123855704137443e7   1.947635251226098e7   2.9374161076725077e7 2.4913439204244353e7  4571215.432861204   6741709.798052819         
        61       2.8010887965656094e7  2.4081637710961927e7  2.1571660185568623e7  1.9646405448533334e7  2.9803937812258136e7 2.481416406780865e7   5218152.228917174   7153502.264468679         
        62       2.819571704141505e7   2.4698301956376497e7  2.151330482906673e7   2.0067906407855257e7  2.9876394411841568e7 2.509093522987269e7   4360438.371345722   7481985.601595413         
        63       2.9394610658651624e7  2.4191891929369293e7  2.1593478653359577e7  1.951336345675608e7   3.1137960524561036e7 2.5374246338501975e7  5047803.609140919   6055518.717008988         
        64       2.8725456860850427e7  2.3947999817410294e7  2.1596966995363604e7  1.9534680483500917e7  2.927240195745573e7  2.5393426236276872e7  4105269.374206607   7378875.942734576         
        65       2.9595483424797136e7  2.4122701050422173e7  2.1704010521769688e7  1.9781657538776986e7  2.97660096388933e7   2.530092707350572e7   4570784.55495708    7165197.160813602         
        66       2.953566554633029e7   2.4849428049940005e7  2.1935388793934785e7  2.054296038319775e7   3.0339199314517327e7 2.5797031777879e7     3619378.04584843    7673897.57672224          
        67       2.955924425835559e7   2.460007012125023e7   2.2230441975230336e7  1.994955510288823e7   3.035355281198905e7  2.6415068381771844e7  5084656.675720443   6397251.131894425         
        68       3.0453291148669437e7  2.4940443178054214e7  2.2136597367251396e7  2.0028251932583753e7  3.1509377510748755e7 2.5893011260744352e7  4502037.581950005   7313072.518300255         
        69       2.9027710356674224e7  2.466096919424548e7   2.254752470745979e7   1.85795920684464e7    3.134036511821134e7  2.5344608839643143e7  3942098.891788482   6825850.78985275          
        70       2.9978451243640486e7  2.5153687641829617e7  2.240508718045543e7   2.007115960611132e7   2.954749434527898e7  2.645902488693394e7   4977025.929393669   7313673.607379019         
        71       3.020837652185051e7   2.5427675043582782e7  2.2671614387267407e7  1.9966691492123324e7  3.2012934877591655e7 2.6267702549250208e7  4557213.718760945   6187002.725214074         
        72       2.965268712947245e7   2.6085011323996298e7  2.197449385856555e7   2.0595462524891306e7  3.0812394570511322e7 2.664521567979512e7   3832630.3457460515  6859984.292559684         
    </script>
    <script src="https://d3js.org/d3.v4.min.js"></script>
    <div id="plot">
        <h1 id="title">Treap</h1>
        <canvas id="canvas" width="800" height="800"></canvas>
        <div id="description"></div>
    </div>
    <div id="key"></div>
    
    <script type="text/javascript">
        var c = d3.select("canvas").call(d3.zoom().scaleExtent([1, 8]).on("zoom", zoom))
        var ctx = c.node().getContext("2d");
        var width = c.property("width");
        var height = c.property("height");
        var transform = null;
        var maxY = 3.2012934877591655e7;
        var y0 = 1503471.0338263402;

        getDataIndex("index.dat").then(es => {
                var sd = document.getElementById("selData");
                sd.innerHTML = "";
                var empty = document.createElement("option");
                empty.setAttribute("selected", "");
                sd.appendChild(empty);
                es.forEach(e => {
                    var o = document.createElement("option");
                    o.setAttribute("value", e.url);
                    o.setAttribute("title", e.description);
                    o.innerText = e.name;
                    maxY = Math.max(maxY, e.maxY);
                    y0 = Math.max(y0, e.y0);
                    sd.appendChild(o);
                });
            });

        var d = document.getElementById('data').innerHTML;
        var data = parseData(d);

        document.onkeydown = e => {
            if (e.keyCode === 27) {
                transform = null;
                ctx.clearRect(0, 0, width, height);
                zoom();
            }
        };
        
        function zoom() {
            if (transform || d3.event) {
                if (d3.event)
                    transform = d3.event.transform;
                ctx.save();
                ctx.clearRect(0, 0, width, height);
                ctx.translate(transform.x, transform.y);
                ctx.scale(transform.k, transform.k);
            }
            drawGraph(ctx, data, y0, maxY, width, height);
            if (transform)
                ctx.restore();
        }
        makeKey(data);
        zoom();

        function reset(titleText = "", descText = "") {
            var desc = document.getElementById("description");
            var title = document.getElementById("title");
            desc.innerText = descText;
            title.innerText = titleText;
            ctx.clearRect(0, 0, width, height);
            makeKey(data);
            zoom();
        }
        
        function loadUrl() {
            var sd = document.getElementById("selData");
            var url = sd.options[sd.selectedIndex].value;
            var titleText = sd.options[sd.selectedIndex].innerText;
            var descText = sd.options[sd.selectedIndex].title;
            if (url) {
                getData(url).then(d => {
                    data = d;
                    reset(titleText, descText);
                });
            }
        }

        function compare() {
            getData("treap.dat").then(da => 
                getData("treap-two.dat").then(db => {
                    data = combine("", da, [0,1,4,5], "2-", db, [0,1,4,5]);
                    reset("Treap Retry Comparison", "Compare hybrid performance with retry policies.");
                }));
        }

        function compareRBTree() {
            getData("rbtree-hybrid-bc-xeon.dat").then(da => 
                getData("rbtree-hybrid-bc-two-xeon.dat").then(db => {
                    data = combine("", da, [0,1,2,3], "2-", db, [0,1,2,3]);
                    reset("RBTree Retry Comparison", "Compare hybrid performance with retry policies.");
                }));
        }

        function makeKey(data) {
            var key = document.getElementById("key");
            key.innerHTML = "";
            var list = document.createElement("ul");
            data.headers.forEach((h,i) => {
                var item = document.createElement("li");
                var t = document.createTextNode(h);
                var c = document.createElement("canvas");
                c.width  = 40;
                c.height = 32;
                var ctx = c.getContext("2d");
                drawKeyItem(ctx, i);
                item.appendChild(c);
                item.appendChild(t);
                list.appendChild(item);
            });
            key.appendChild(list);
        }
    </script>
</body>
</html>
